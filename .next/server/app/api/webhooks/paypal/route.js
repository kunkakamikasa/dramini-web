"use strict";(()=>{var e={};e.id=656,e.ids=[656],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4476:(e,o,r)=>{r.r(o),r.d(o,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>P,routeModule:()=>y,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{POST:()=>c});var t=r(9303),n=r(8716),s=r(670),i=r(7070);async function c(e){try{let o=await e.text(),r=e.headers.get("paypal-transmission-id"),a=e.headers.get("paypal-webhook-id"),t=e.headers.get("paypal-transmission-time"),n=e.headers.get("paypal-transmission-sig"),s=e.headers.get("paypal-cert-url"),c=e.headers.get("paypal-auth-algo");if(!r||!a||!t||!n||!s||!c)return console.error("Missing PayPal webhook headers"),i.NextResponse.json({error:"Missing headers"},{status:400});let y=process.env.PAYPAL_WEBHOOK_ID;if(a!==y)return console.error("Invalid PayPal webhook ID"),i.NextResponse.json({error:"Invalid webhook ID"},{status:400});if(!await p(o,r,t,n,s,c,a))return console.error("Invalid PayPal webhook signature"),i.NextResponse.json({error:"Invalid signature"},{status:400});let P=JSON.parse(o);switch(console.log("PayPal webhook received:",P.event_type),P.event_type){case"PAYMENT.CAPTURE.COMPLETED":await l(P);break;case"PAYMENT.CAPTURE.DENIED":await d(P);break;case"PAYMENT.CAPTURE.REFUNDED":await u(P);break;case"CHECKOUT.ORDER.APPROVED":await h(P);break;default:console.log("Unhandled PayPal event type:",P.event_type)}return i.NextResponse.json({received:!0})}catch(e){return console.error("PayPal webhook error:",e),i.NextResponse.json({error:"Webhook processing failed"},{status:500})}}async function p(e,o,r,a,t,n,s){try{let i=process.env.PAYPAL_CLIENT_ID,c=process.env.PAYPAL_CLIENT_SECRET,p=process.env.PAYPAL_ENVIRONMENT||"live";if(!i||!c)return console.error("PayPal credentials not configured"),!1;let l="live"===p?"https://api-m.paypal.com":"https://api-m.sandbox.paypal.com",d={auth_algo:n,cert_id:t,transmission_id:o,transmission_sig:a,transmission_time:r,webhook_id:s,webhook_event:JSON.parse(e)},u=await fetch(`${l}/v1/oauth2/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${Buffer.from(`${i}:${c}`).toString("base64")}`},body:"grant_type=client_credentials"});if(!u.ok)return console.error("Failed to get PayPal access token"),!1;let h=(await u.json()).access_token,y=await fetch(`${l}/v1/notifications/verify-webhook-signature`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`},body:JSON.stringify(d)});if(!y.ok)return console.error("PayPal webhook verification failed"),!1;let P=await y.json();return"SUCCESS"===P.verification_status}catch(e){return console.error("PayPal webhook verification error:",e),!1}}async function l(e){try{let o=e.resource,r=o.custom_id;if(!r){console.error("No custom_id in PayPal payment capture");return}let{plan:a,priceCents:t,meta:n}=JSON.parse(r);console.log("Payment completed:",{plan:a,priceCents:t,coins:n.coins,bonus:n.bonus,episodeId:n.episodeId,titleId:n.titleId});let s=await fetch("https://dramini-api.onrender.com/api/v1/user/coins/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n.userId,coins:n.coins+n.bonus,source:"paypal_purchase",transactionId:o.id,planId:a})});s.ok||console.error("Failed to update user coins:",s.statusText)}catch(e){console.error("Error handling payment completed:",e)}}async function d(e){try{let o=e.resource;console.log("Payment denied:",o.id)}catch(e){console.error("Error handling payment denied:",e)}}async function u(e){try{let o=e.resource;console.log("Payment refunded:",o.id)}catch(e){console.error("Error handling payment refunded:",e)}}async function h(e){try{let o=e.resource;console.log("Order approved:",o.id)}catch(e){console.error("Error handling order approved:",e)}}let y=new t.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/paypal/route",pathname:"/api/webhooks/paypal",filename:"route",bundlePath:"app/api/webhooks/paypal/route"},resolvedPagePath:"/Users/mayingkun/mkwork/cursorproject/H5/Dramini/app/api/webhooks/paypal/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:P,staticGenerationAsyncStorage:m,serverHooks:g}=y,f="/api/webhooks/paypal/route";function v(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),a=o.X(0,[276,972],()=>r(4476));module.exports=a})();